#!/bin/bash

#todo get environment variables with echo

#assumes it will receives the appropriate file path on alma-integrations
READER=ndj
WRITER=solr
HERE=`dirname $0`
SCRIPTDIR=`realpath $HERE`
TDIR="/app"
SCRATCHDIR="/app/scratch"

#set up the file
pkg_file=$1

#set the url for Solr
SOLR_URL=$2
echo "Indexing into $SOLR_URL"
#copy file from alma-integrations to scratch directory
# '@' removes printing interactive session
curl -u $HT_USERNAME:$HT_PASSWORD $HT_HOST/catalog/$pkg_file > $SCRATCHDIR/$pkg_file

#gets just the file name without the parent directory info
file=${pkg_file##*/}

filename=`echo ${SCRATCHDIR}/${file}`
echo $file
echo $filename

ls -l scratch

#run index the file
cmd="bundle exec traject 
  -c $TDIR/readers/$READER.rb 
  -c $TDIR/writers/$WRITER.rb
  -c $TDIR/indexers/settings.rb
  -c $TDIR/indexers/common.rb 
  -c $TDIR/indexers/common_ht.rb
  -c $TDIR/indexers/subject_topic.rb
  -c $TDIR/indexers/umich.rb 
  -c $TDIR/indexers/umich_alma.rb 
  -s log.file=STDOUT 
  -u $SOLR_URL
  $filename"

$cmd

rm $filename
exit $?  
